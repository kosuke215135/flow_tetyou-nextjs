# 機能仕様書: Flow Tetyou (フロー手帳)

## 1. 概要

### 1.1. アプリケーション名
Flow Tetyou (フロー手帳)

### 1.2. コンセプト
**「思考を深堀りして、モヤモヤを整理する手帳」**

モヤモヤしたメモを書いたとき、ただメモで終わってしまう課題を解決する。AIアシスタント「ドゥイットくん」が「なぜ？」を繰り返し問いかけることで、ユーザー自身が答えを見つけ、思考をツリー構造で可視化できるメモアプリケーション。

### 1.3. 解決する課題
- モヤモヤした思考をメモしても、それが何なのか整理できずに終わってしまう。
- 一人で考えていると、思考が堂々巡りになりがち。
- 「なぜ？」を繰り返すことで、本質的な課題や本当にやりたいことが見えてくる。
- 思考の過程を可視化することで、自分の考えを客観的に見られる。

### 1.4. ターゲットユーザー
- モヤモヤした思考を整理したい人。
- アイデアや思考をメモする習慣はあるが、それを深く掘り下げるのが苦手な人。
- クリエイター、企画職、学生など、思考の整理を頻繁に行う人。
- 自分自身と対話しながら考えを深めたい人。

---

## 2. コア機能

### 2.1. メモ作成機能
- **機能概要**: ユーザーがモヤモヤしたメモを自由に書ける。
- **入力方法**: TipTapエディタによるリッチテキスト入力（タスクリスト、コードブロック、リンク対応）
- **保存**: サーバーアクション`createNote()`でデータベースに保存（depth=0の親ノート）

### 2.2. 深堀りモード（思考ツリー機能）
- **機能概要**: メモをドラッグ&ドロップすることで、ドゥイットくんが「なぜ？」を5回繰り返し、思考を深堀りする。
- **実装方法**:
  1. ユーザーが親ノートを「ドゥイットくんエリア」にドラッグ&ドロップ
  2. ドゥイットくんがGemini AIで質問を生成（「なぜ〇〇なんだ？」）
  3. ユーザーが質問に答えて、子ノートとして保存（parentNoteId、depth、question付き）
  4. 次の質問を生成し、5回繰り返す（depth 1→2→...→5）
  5. 最後の質問（depth 4）は「で、どうしたいんだ？」という行動を促すプロンプトに変更

### 2.3. ツリー表示機能
- **機能概要**: 親ノートと子ノートをツリー構造で表示。深堀り履歴を視覚的に整理できる。
- **表示要素**:
  - 親ノート（depth=0）: ドラッグ可能なカード形式
  - 子ノート（depth 1-5）: インデント表示、質問（Q:）と回答（A:）の区別
  - 折りたたみボタン: 親ノート下部にインデックスシール風のボタンを配置、深堀り履歴を折りたたみ/展開可能

### 2.4. ドゥイットくんエリア
- **機能概要**: 画面右側に配置された、ドロップゾーン兼深堀りモードのUIエリア
- **状態**:
  - 待機中: 「ここにノートをドロップして深堀りを始めよう！」と表示
  - 深堀り中: 質問表示 + TipTapエディタ + 進捗表示（1/5, 2/5, ...）
  - ローディング中: スピナー表示
  - エラー時: エラーメッセージ表示

---

## 3. データモデル

### 3.1. User
```prisma
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  notes         Note[]
  accounts      Account[]
  sessions      Session[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}
```

### 3.2. Note
```prisma
model Note {
  id        String   @id @default(cuid())
  content   Json     // TipTapのJSON形式
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 思考ツリー機能
  parentNoteId String? // 親ノートのID
  depth        Int     @default(0) // 深堀りの深さ（0=親ノート、1-5=子ノート）
  question     String? // ドゥイットくんからの質問

  // リレーション
  parent   Note?  @relation("NoteTree", fields: [parentNoteId], references: [id], onDelete: Cascade)
  children Note[] @relation("NoteTree")

  @@index([userId])
  @@index([parentNoteId])
}
```

---

## 4. 主要なフロー

### 4.1. ノート作成フロー
1. ユーザーがTipTapエディタで入力
2. `handleNoteSubmit()`がSWRでOptimistic UIを更新
3. `createNote()`サーバーアクションがDBに保存（depth=0の親ノート）
4. SWRが自動再検証でノートリストを更新

### 4.2. 深堀りフロー
1. ユーザーが親ノートを「ドゥイットくんエリア」にドラッグ&ドロップ
2. `DoitKunArea`が深堀りモードを起動
3. `generateDeepDiveQuestion(parentNoteId, currentDepth)`サーバーアクションがGemini AIで質問を生成
4. 質問を表示（例: 「なぜ〇〇なんだ？」）
5. ユーザーがTipTapエディタで回答を入力
6. `createChildNote(parentNoteId, depth, question, content)`サーバーアクションが子ノートとして保存
7. 次の質問を生成（depth 1→2→...→5）
8. 5回繰り返して深堀り完了
9. SWRが再検証し、ツリー構造で表示

### 4.3. ツリー表示フロー
1. `getNotes()`が親ノート（depth=0）のみを取得
2. 各親ノートは`children`リレーションで子ノートを再帰的に含む（depth=5まで）
3. `NoteCard.tsx`が親ノートを表示し、折りたたみ可能な子ノートを表示
4. 子ノートには質問（Q:）と回答（A:）が表示される

---

## 5. UI/UX

### 5.1. レイアウト
- **画面構成**: 2カラムレイアウト
  - 左側: ノート作成エディタ + ノートリスト（ツリー表示）
  - 右側: ドゥイットくんエリア（ドロップゾーン + 深堀りモード）

### 5.2. ドラッグ&ドロップ
- **ライブラリ**: @dnd-kit/core
- **ドラッグ可能**: 親ノート（depth=0）のみ
- **ドロップゾーン**: ドゥイットくんエリア
- **視覚的フィードバック**:
  - ドラッグ中: ノートのopacity 0.5
  - ドロップゾーン上: 青背景でハイライト

### 5.3. ツリー表示デザイン
- **親ノート**: カード形式、白背景
- **子ノート**:
  - インデント表示（depth に応じて左マージン増加）
  - 質問（Q:）: 青背景、💪アイコン
  - 回答（A:）: 灰色背景
  - 親子関係を示す線: border-left
- **折りたたみボタン**:
  - 位置: 親ノート下部左側に配置（ノートの外側）
  - デザイン: インデックスシール風、青背景、角丸
  - テキスト: "深堀りN" （Nは子ノート数）
  - アイコン: ▼（展開中）/ ▶（折りたたみ中）

---

## 6. AI統合（Gemini API）

### 6.1. モデル
- **モデル**: gemini-2.5-flash

### 6.2. 深堀り質問生成
- **関数**: `generateDeepDiveQuestion(parentNoteId, currentDepth)`
- **プロンプト例（depth 0-3）**:
  ```
  君はドゥイットくん。脳筋行動派のパーソナルトレーナー（ニート）だ。

  ユーザーの以下のモヤモヤメモに対して、核心を突く「なぜ？」の質問を1つ考えろ。
  論理は破綻してても構わない。むしろドゥイットくんらしい脳筋質問が良い。

  メモ: 「${noteContent}」

  一人称は「オレ」、二人称は「君」を使え。
  短く、シンプルに。質問文だけを返せ。
  ```
- **プロンプト（depth 4）**:
  ```
  君はドゥイットくん。脳筋行動派のパーソナルトレーナー（ニート）だ。

  ユーザーのモヤモヤメモとその深堀りを読んで、最後に「で、どうしたいんだ？」と行動を促す質問を考えろ。

  メモ: 「${noteContent}」
  これまでの回答: 「${allAnswers}」

  一人称は「オレ」、二人称は「君」を使え。
  短く、シンプルに。質問文だけを返せ。
  ```

---

## 7. 技術スタック

- **フレームワーク**: Next.js 15 (App Router)
- **言語**: TypeScript
- **データベース**: PostgreSQL + Prisma ORM
- **認証**: NextAuth.js v5 (beta) with Google OAuth
- **AI**: Google Gemini API (gemini-2.5-flash model)
- **スタイリング**: Tailwind CSS v4
- **リッチテキスト**: TipTap editor
- **ドラッグ&ドロップ**: @dnd-kit/core, @dnd-kit/utilities
- **状態管理**: SWR (データフェッチとキャッシュ)
- **パッケージマネージャー**: pnpm

---

## 8. 今後の拡張案

### 8.1. エクスポート機能
- 思考ツリーをMarkdownやPDF形式でエクスポート

### 8.2. 検索機能
- ノートの全文検索、タグ機能

### 8.3. 共有機能
- 思考ツリーを他のユーザーと共有

### 8.4. カスタマイズ
- ドゥイットくんのキャラクター設定をカスタマイズ
- 質問の回数（現在は5回固定）を変更可能に

---

## 9. 制約・注意事項

- 深堀りは5回までの制限（depth 0-4）
- 親ノート（depth=0）のみドラッグ可能
- 深堀り中は他の操作ができない（モーダル的な動作）
- Gemini APIのレート制限に注意
